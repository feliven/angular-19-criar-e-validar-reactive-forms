<div class="cadastro-form">
  <div class="cadastro-form__container">
    <div class="cadastro-form__card">
      <h2 class="cadastro-form__title">
        {{ configuracaoDeFormulario.titulo }}
      </h2>

      <p class="cadastro-form__description">
        {{ configuracaoDeFormulario.descricao }}
      </p>

      <form [formGroup]="dadosPessoaisForm" (ngSubmit)="onProximo()">
        @for (campo of configuracaoDeFormulario.campos; track
        campo.formControlName) {
        <!-- Text and Email Fields -->
        @if (campo.type === 'text' || campo.type === 'email') {
        <div
          class="cadastro-form__field"
          [ngClass]="{ 'cadastro-form__field--half': campo.width === 'half' }"
        >
          <label [for]="campo.formControlName" class="cadastro-form__label">
            {{ campo.label }}
          </label>
          <input
            [id]="campo.formControlName"
            [type]="campo.type"
            class="cadastro-form__input"
            [formControlName]="campo.formControlName"
            [placeholder]="campo.placeholder || ''"
          />

          <!-- Error Messages -->
          @if (dadosPessoaisForm.get(campo.formControlName)?.invalid &&
          dadosPessoaisForm.get(campo.formControlName)?.touched) { @for
          (mensagemErro of campo.errorMessages | keyvalue; track
          mensagemErro.key) { @if
          (dadosPessoaisForm.get(campo.formControlName)?.errors?.[mensagemErro.key])
          {
          <div class="cadastro-form__error">
            <span>{{ mensagemErro.value }}</span>
          </div>
          } } }
        </div>
        }

        <!-- Password Fields -->
        @else if (campo.type === 'password' && campo.formControlName ===
        'senha') {
        <div class="cadastro-form__row">
          <div class="cadastro-form__field cadastro-form__field--half">
            <label [for]="campo.formControlName" class="cadastro-form__label">
              {{ campo.label }}
            </label>
            <input
              [id]="campo.formControlName"
              type="password"
              class="cadastro-form__input"
              [formControlName]="campo.formControlName"
            />

            <!-- Error Messages -->
            @if (dadosPessoaisForm.get(campo.formControlName)?.invalid &&
            dadosPessoaisForm.get(campo.formControlName)?.touched) { @for
            (mensagemErro of campo.errorMessages | keyvalue; track
            mensagemErro.key) { @if
            (dadosPessoaisForm.get(campo.formControlName)?.errors?.[mensagemErro.key])
            {
            <div class="cadastro-form__error">
              <span>{{ mensagemErro.value }}</span>
            </div>
            } } }
          </div>

          <!-- Repita Senha field in the same row -->
          @for (repitaSenhaCampo of configuracaoDeFormulario.campos; track
          repitaSenhaCampo.formControlName) { @if
          (repitaSenhaCampo.formControlName === 'repitaSenha') {
          <div class="cadastro-form__field cadastro-form__field--half">
            <label
              [for]="repitaSenhaCampo.formControlName"
              class="cadastro-form__label"
            >
              {{ repitaSenhaCampo.label }}
            </label>
            <input
              [id]="repitaSenhaCampo.formControlName"
              type="password"
              class="cadastro-form__input"
              [formControlName]="repitaSenhaCampo.formControlName"
            />

            <!-- Error Messages -->
            @if
            (dadosPessoaisForm.get(repitaSenhaCampo.formControlName)?.invalid &&
            dadosPessoaisForm.get(repitaSenhaCampo.formControlName)?.touched) {
            @for (mensagemErro of repitaSenhaCampo.errorMessages | keyvalue;
            track mensagemErro.key) { @if
            (dadosPessoaisForm.get(repitaSenhaCampo.formControlName)?.errors?.[mensagemErro.key])
            {
            <div class="cadastro-form__error">
              <span>{{ mensagemErro.value }}</span>
            </div>
            } } }
          </div>
          } }
        </div>
        }

        <!-- Skip repitaSenha field in main loop since it's handled with senha -->
        @else if (campo.type === 'password' && campo.formControlName ===
        'repitaSenha') {
        <!-- Handled in senha row -->
        }

        <!-- Select Fields (Estado) -->
        @else if (campo.type === 'select' && campo.formControlName === 'estado')
        {
        <div class="cadastro-form__row">
          <div class="cadastro-form__field cadastro-form__field--half">
            <label [for]="campo.formControlName" class="cadastro-form__label">
              {{ campo.label }}
            </label>
            <select
              [id]="campo.formControlName"
              class="cadastro-form__select"
              [formControlName]="campo.formControlName"
            >
              <option value="" disabled selected>
                {{ campo.placeholder }}
              </option>
              @for (estado of (estados$ | async); track estado.sigla) {
              <option [value]="estado.sigla">{{ estado.nome }}</option>
              }
            </select>

            <!-- Error Messages -->
            @if (dadosPessoaisForm.get(campo.formControlName)?.invalid &&
            dadosPessoaisForm.get(campo.formControlName)?.touched) { @for
            (mensagemErro of campo.errorMessages | keyvalue; track
            mensagemErro.key) { @if
            (dadosPessoaisForm.get(campo.formControlName)?.errors?.[mensagemErro.key])
            {
            <div class="cadastro-form__error">
              <span>{{ mensagemErro.value }}</span>
            </div>
            } } }
          </div>

          <!-- Cidade field in the same row -->
          @for (cidadeCampo of configuracaoDeFormulario.campos; track
          cidadeCampo.formControlName) { @if (cidadeCampo.formControlName ===
          'cidade') {
          <div class="cadastro-form__field cadastro-form__field--half">
            <label
              [for]="cidadeCampo.formControlName"
              class="cadastro-form__label"
            >
              {{ cidadeCampo.label }}
            </label>
            <select
              [id]="cidadeCampo.formControlName"
              class="cadastro-form__select"
              [formControlName]="cidadeCampo.formControlName"
            >
              <option value="" disabled selected>
                {{
                  (carregandoCidades$ | async)
                    ? "Carregando..."
                    : cidadeCampo.placeholder
                }}
              </option>
              @for (cidade of (cidades$ | async); track cidade.nome) {
              <option [value]="cidade.nome">{{ cidade.nome }}</option>
              }
            </select>

            <!-- Error Messages -->
            @if (dadosPessoaisForm.get(cidadeCampo.formControlName)?.invalid &&
            dadosPessoaisForm.get(cidadeCampo.formControlName)?.touched) { @for
            (mensagemErro of cidadeCampo.errorMessages | keyvalue; track
            mensagemErro.key) { @if
            (dadosPessoaisForm.get(cidadeCampo.formControlName)?.errors?.[mensagemErro.key])
            {
            <div class="cadastro-form__error">
              <span>{{ mensagemErro.value }}</span>
            </div>
            } } }
          </div>
          } }
        </div>
        }

        <!-- Skip cidade field in main loop since it's handled with estado -->
        @else if (campo.type === 'select' && campo.formControlName === 'cidade')
        {
        <!-- Handled in estado row -->
        } }

        <!-- Form-level error: Senhas não coincidem -->
        @if (dadosPessoaisForm.errors?.['senhasSaoDiferentes'] &&
        dadosPessoaisForm.get('repitaSenha')?.touched) {
        <div class="cadastro-form__error">As senhas não coincidem</div>
        }

        <div class="cadastro-form__actions">
          <app-button
            text="Anterior"
            type="outline"
            icon="fas fa-arrow-left"
            iconPosition="left"
            (clicked)="onAnterior()"
          >
          </app-button>

          <app-button
            text="Próximo"
            type="primary"
            icon="fas fa-arrow-right"
            iconPosition="right"
            [disabled]="dadosPessoaisForm.invalid"
            (clicked)="onProximo()"
          >
          </app-button>
        </div>
      </form>
    </div>
  </div>
</div>
